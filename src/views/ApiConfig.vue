<template>
  <div class="api-config">
    <!-- È°µÈù¢Â§¥ÈÉ® -->
    <div class="page-header">
      <div class="header-content">
        <h1>‚öôÔ∏è APIÈÖçÁΩÆ</h1>
        <p>ÁÆ°ÁêÜAIÊ®°ÂûãÊé•Âè£ÈÖçÁΩÆÂíåÂèÇÊï∞ËÆæÁΩÆ</p>
      </div>
      <div class="header-actions">
        <el-button @click="testAllConnections">
          <el-icon><Connection /></el-icon>
          ÊµãËØïÊâÄÊúâËøûÊé•
        </el-button>
        <el-button type="primary" @click="saveAllConfigs">
          <el-icon><Check /></el-icon>
          ‰øùÂ≠òÈÖçÁΩÆ
        </el-button>
      </div>
    </div>

    <!-- ÈÖçÁΩÆÁä∂ÊÄÅÊ¶ÇËßà -->
    <div class="config-overview">
      <el-row :gutter="20">
        <el-col :span="6">
          <el-card class="status-card">
            <div class="status-item">
              <div class="status-icon success">
                <el-icon><CircleCheck /></el-icon>
              </div>
              <div class="status-content">
                <div class="status-value">{{ activeConfigs }}</div>
                <div class="status-label">Â∑≤ÈÖçÁΩÆ</div>
              </div>
            </div>
          </el-card>
        </el-col>
        <el-col :span="6">
          <el-card class="status-card">
            <div class="status-item">
              <div class="status-icon warning">
                <el-icon><Warning /></el-icon>
              </div>
              <div class="status-content">
                <div class="status-value">{{ pendingConfigs }}</div>
                <div class="status-label">ÂæÖÈÖçÁΩÆ</div>
              </div>
            </div>
          </el-card>
        </el-col>
        <el-col :span="6">
          <el-card class="status-card">
            <div class="status-item">
              <div class="status-icon info">
                <el-icon><Connection /></el-icon>
              </div>
              <div class="status-content">
                <div class="status-value">{{ connectedConfigs }}</div>
                <div class="status-label">ËøûÊé•Ê≠£Â∏∏</div>
              </div>
            </div>
          </el-card>
        </el-col>
        <el-col :span="6">
          <el-card class="status-card">
            <div class="status-item">
              <div class="status-icon primary">
                <el-icon><Star /></el-icon>
              </div>
              <div class="status-content">
                <div class="status-value">{{ defaultModel }}</div>
                <div class="status-label">ÈªòËÆ§Ê®°Âûã</div>
              </div>
            </div>
          </el-card>
        </el-col>
      </el-row>
    </div>

    <!-- APIÈÖçÁΩÆÂàóË°® -->
    <div class="config-list">
      <el-card>
        <template #header>
          <div class="card-header">
            <h3>ü§ñ AIÊ®°ÂûãÈÖçÁΩÆ</h3>
            <el-button type="primary" @click="addNewConfig">
              <el-icon><Plus /></el-icon>
              Ê∑ªÂä†ÈÖçÁΩÆ
            </el-button>
          </div>
        </template>
        
        <div class="config-tabs">
          <el-tabs v-model="activeTab" type="border-card">
            <el-tab-pane 
              v-for="config in apiConfigs" 
              :key="config.id"
              :label="config.name"
              :name="config.id"
            >
              <div class="config-content">
                <!-- Âü∫Êú¨‰ø°ÊÅØ -->
                <div class="config-section">
                  <h4>üìã Âü∫Êú¨‰ø°ÊÅØ</h4>
                  <el-row :gutter="20">
                    <el-col :span="12">
                      <el-form-item label="ÈÖçÁΩÆÂêçÁß∞">
                        <el-input v-model="config.name" placeholder="ËØ∑ËæìÂÖ•ÈÖçÁΩÆÂêçÁß∞" />
                      </el-form-item>
                    </el-col>
                    <el-col :span="12">
                      <el-form-item label="Ê®°ÂûãÁ±ªÂûã">
                        <el-select v-model="config.type" placeholder="ÈÄâÊã©Ê®°ÂûãÁ±ªÂûã">
                          <el-option label="OpenAI GPT" value="openai" />
                          <el-option label="Claude" value="claude" />
                          <el-option label="ÊñáÂøÉ‰∏ÄË®Ä" value="wenxin" />
                          <el-option label="ÈÄö‰πâÂçÉÈóÆ" value="qwen" />
                          <el-option label="Êô∫Ë∞±AI" value="zhipu" />
                          <el-option label="Ëá™ÂÆö‰πâ" value="custom" />
                        </el-select>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  
                  <el-row :gutter="20">
                    <el-col :span="24">
                      <el-form-item label="ÊèèËø∞">
                        <el-input 
                          v-model="config.description" 
                          type="textarea" 
                          :rows="2"
                          placeholder="ËØ∑ËæìÂÖ•ÈÖçÁΩÆÊèèËø∞"
                        />
                      </el-form-item>
                    </el-col>
                  </el-row>
                </div>

                <!-- ËøûÊé•ÈÖçÁΩÆ -->
                <div class="config-section">
                  <h4>üîó ËøûÊé•ÈÖçÁΩÆ</h4>
                  <el-row :gutter="20">
                    <el-col :span="24">
                      <el-form-item label="APIÂú∞ÂùÄ">
                        <el-input v-model="config.apiUrl" placeholder="ËØ∑ËæìÂÖ•APIÂú∞ÂùÄ">
                          <template #prepend>HTTPS://</template>
                        </el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  
                  <el-row :gutter="20">
                    <el-col :span="24">
                      <el-form-item label="APIÂØÜÈí•">
                        <el-input 
                          v-model="config.apiKey" 
                          type="password" 
                          placeholder="ËØ∑ËæìÂÖ•APIÂØÜÈí•"
                          show-password
                        >
                          <template #append>
                            <el-button @click="testConnection(config)">
                              <el-icon><Connection /></el-icon>
                            </el-button>
                          </template>
                        </el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  
                  <el-row :gutter="20">
                    <el-col :span="12">
                      <el-form-item label="Ê®°ÂûãÂêçÁß∞">
                        <el-input v-model="config.model" placeholder="Â¶ÇÔºögpt-4, claude-3" />
                      </el-form-item>
                    </el-col>
                    <el-col :span="12">
                      <el-form-item label="ËøûÊé•Áä∂ÊÄÅ">
                        <el-tag 
                          :type="getStatusType(config.status)"
                          :icon="getStatusIcon(config.status)"
                        >
                          {{ getStatusText(config.status) }}
                        </el-tag>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </div>

                <!-- Ê®°ÂûãÂèÇÊï∞ -->
                <div class="config-section">
                  <h4>üéõÔ∏è Ê®°ÂûãÂèÇÊï∞</h4>
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="Ê∏©Â∫¶ (Temperature)">
                        <el-slider 
                          v-model="config.temperature" 
                          :min="0" 
                          :max="2" 
                          :step="0.1"
                          show-input
                        />
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="ÊúÄÂ§ßTokenÊï∞">
                        <div class="max-tokens-control">
                          <el-checkbox 
                            v-model="config.unlimitedTokens" 
                            @change="handleUnlimitedTokensChange(config)"
                            style="margin-bottom: 8px;"
                          >
                            Êó†ÈôêÂà∂
                          </el-checkbox>
                          <el-input-number 
                            v-model="config.maxTokens" 
                            :min="1" 
                            :max="10000000"
                            :step="1000"
                            :disabled="config.unlimitedTokens"
                            placeholder="Êó†ÈôêÂà∂"
                          />
                        </div>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="Top P">
                        <el-slider 
                          v-model="config.topP" 
                          :min="0" 
                          :max="1" 
                          :step="0.1"
                          show-input
                        />
                      </el-form-item>
                    </el-col>
                  </el-row>
                  
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="È¢ëÁéáÊÉ©ÁΩö">
                        <el-slider 
                          v-model="config.frequencyPenalty" 
                          :min="-2" 
                          :max="2" 
                          :step="0.1"
                          show-input
                        />
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="Â≠òÂú®ÊÉ©ÁΩö">
                        <el-slider 
                          v-model="config.presencePenalty" 
                          :min="-2" 
                          :max="2" 
                          :step="0.1"
                          show-input
                        />
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="Ë∂ÖÊó∂Êó∂Èó¥(Áßí)">
                        <el-input-number 
                          v-model="config.timeout" 
                          :min="5" 
                          :max="300"
                          :step="5"
                        />
                      </el-form-item>
                    </el-col>
                  </el-row>
                </div>

                <!-- È´òÁ∫ßËÆæÁΩÆ -->
                <div class="config-section">
                  <h4>üîß È´òÁ∫ßËÆæÁΩÆ</h4>
                  <el-row :gutter="20">
                    <el-col :span="12">
                      <el-form-item>
                        <el-checkbox v-model="config.isDefault">ËÆæ‰∏∫ÈªòËÆ§Ê®°Âûã</el-checkbox>
                      </el-form-item>
                      <el-form-item>
                        <el-checkbox v-model="config.enabled">ÂêØÁî®Ê≠§ÈÖçÁΩÆ</el-checkbox>
                      </el-form-item>
                      <el-form-item>
                        <el-checkbox v-model="config.streamMode">ÂêØÁî®ÊµÅÂºèËæìÂá∫</el-checkbox>
                      </el-form-item>
                    </el-col>
                    <el-col :span="12">
                      <el-form-item label="ÈáçËØïÊ¨°Êï∞">
                        <el-input-number 
                          v-model="config.retryCount" 
                          :min="0" 
                          :max="5"
                        />
                      </el-form-item>
                      <el-form-item label="‰ºòÂÖàÁ∫ß">
                        <el-input-number 
                          v-model="config.priority" 
                          :min="1" 
                          :max="10"
                        />
                      </el-form-item>
                    </el-col>
                  </el-row>
                  
                  <el-row :gutter="20">
                    <el-col :span="24">
                      <el-form-item label="Ëá™ÂÆö‰πâHeaders">
                        <el-input 
                          v-model="config.customHeaders" 
                          type="textarea" 
                          :rows="3"
                          placeholder="JSONÊ†ºÂºèÔºåÂ¶ÇÔºö{'User-Agent': 'MyApp/1.0'}"
                        />
                      </el-form-item>
                    </el-col>
                  </el-row>
                </div>

                <!-- Êìç‰ΩúÊåâÈíÆ -->
                <div class="config-actions">
                  <el-button @click="resetConfig(config)">ÈáçÁΩÆ</el-button>
                  <el-button @click="duplicateConfig(config)">Â§çÂà∂ÈÖçÁΩÆ</el-button>
                  <el-button type="warning" @click="testConnection(config)">
                    <el-icon><Connection /></el-icon>
                    ÊµãËØïËøûÊé•
                  </el-button>
                  <el-button type="primary" @click="saveConfig(config)">
                    <el-icon><Check /></el-icon>
                    ‰øùÂ≠òÈÖçÁΩÆ
                  </el-button>
                  <el-button @click="showHistory = true">APIÂéÜÂè≤ÁÆ°ÁêÜ</el-button>
                  <el-button 
                    type="danger" 
                    @click="deleteConfig(config.id)"
                    :disabled="config.isDefault"
                  >
                    <el-icon><Delete /></el-icon>
                    Âà†Èô§
                  </el-button>
                </div>
              </div>
            </el-tab-pane>
          </el-tabs>
        </div>
      </el-card>
    </div>

    <!-- È¢ÑËÆæÊ®°Êùø -->
    <div class="preset-templates">
      <el-card>
        <template #header>
          <h3>üì¶ È¢ÑËÆæÊ®°Êùø</h3>
        </template>
        
        <div class="template-grid">
          <div 
            v-for="template in presetTemplates"
            :key="template.id"
            class="template-card"
            @click="applyTemplate(template)"
          >
            <div class="template-icon">
              {{ template.icon }}
            </div>
            <div class="template-content">
              <h4>{{ template.name }}</h4>
              <p>{{ template.description }}</p>
              <div class="template-tags">
                <el-tag 
                  v-for="tag in template.tags"
                  :key="tag"
                  size="small"
                  type="info"
                >
                  {{ tag }}
                </el-tag>
              </div>
            </div>
          </div>
        </div>
      </el-card>
    </div>

    <!-- ÂØºÂÖ•ÂØºÂá∫ -->
    <div class="import-export">
      <el-card>
        <template #header>
          <h3>üìÅ ÂØºÂÖ•ÂØºÂá∫</h3>
        </template>
        
        <div class="import-export-actions">
          <div class="action-group">
            <h4>ÂØºÂá∫ÈÖçÁΩÆ</h4>
            <p>Â∞ÜÂΩìÂâçÊâÄÊúâÈÖçÁΩÆÂØºÂá∫‰∏∫JSONÊñá‰ª∂</p>
            <el-button @click="exportConfigs">
              <el-icon><Download /></el-icon>
              ÂØºÂá∫ÈÖçÁΩÆ
            </el-button>
          </div>
          
          <div class="action-group">
            <h4>ÂØºÂÖ•ÈÖçÁΩÆ</h4>
            <p>‰ªéJSONÊñá‰ª∂ÂØºÂÖ•ÈÖçÁΩÆÔºà‰ºöË¶ÜÁõñÁé∞ÊúâÈÖçÁΩÆÔºâ</p>
            <el-upload
              :before-upload="importConfigs"
              :show-file-list="false"
              accept=".json"
            >
              <el-button>
                <el-icon><Upload /></el-icon>
                ÈÄâÊã©Êñá‰ª∂
              </el-button>
            </el-upload>
          </div>
          
          <div class="action-group">
            <h4>ÈáçÁΩÆÊâÄÊúâ</h4>
            <p>ÈáçÁΩÆÊâÄÊúâÈÖçÁΩÆ‰∏∫ÈªòËÆ§ÂÄºÔºàË∞®ÊÖéÊìç‰ΩúÔºâ</p>
            <el-button type="danger" @click="resetAllConfigs">
              <el-icon><RefreshLeft /></el-icon>
              ÈáçÁΩÆÊâÄÊúâ
            </el-button>
          </div>
        </div>
      </el-card>
    </div>

    <el-dialog v-model="showHistory" title="APIÂéÜÂè≤ÁÆ°ÁêÜ" width="850px">
      <ApiHistoryManager />
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { 
  Connection, Check, CircleCheck, Warning, Star, Plus,
  Delete, Download, Upload, RefreshLeft
} from '@element-plus/icons-vue'
import ApiHistoryManager from '@/components/ApiHistoryManager.vue'

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const activeTab = ref('1')

// È¢ÑËÆæÁöÑAPIÈÖçÁΩÆÁ§∫‰æãÊï∞ÊçÆ - Ê∏ÖÁ©∫‰∏∫Áî®Êà∑Ëá™Ë°åÈÖçÁΩÆ
const apiConfigs = ref([])

// È¢ÑËÆæÊ®°Êùø
const presetTemplates = ref([
  {
    id: 'openai-gpt4',
    name: 'OpenAI GPT-4',
    icon: 'ü§ñ',
    description: 'ÊúÄÂº∫Â§ßÁöÑÈÄöÁî®AIÊ®°ÂûãÔºåÈÄÇÂêàÂ§çÊùÇÂàõ‰Ωú‰ªªÂä°',
    tags: ['ÈÄöÁî®', 'Âº∫Â§ß', 'ÂàõÊÑè'],
    config: {
      type: 'openai',
      apiUrl: 'api.openai.com/v1/chat/completions',
      model: 'gpt-4',
      temperature: 0.7,
      maxTokens: null // ÁßªÈô§tokenÈôêÂà∂
    }
  },
  {
    id: 'openai-gpt35',
    name: 'OpenAI GPT-3.5',
    icon: '‚ö°',
    description: 'Âø´ÈÄüÂìçÂ∫îÔºåÊàêÊú¨ËæÉ‰ΩéÔºåÈÄÇÂêàÊó•Â∏∏ÂÜô‰Ωú',
    tags: ['Âø´ÈÄü', 'ÁªèÊµé', 'ÂÆûÁî®'],
    config: {
      type: 'openai',
      apiUrl: 'api.openai.com/v1/chat/completions',
      model: 'gpt-3.5-turbo',
      temperature: 0.7,
              maxTokens: null // ÁßªÈô§tokenÈôêÂà∂
    }
  },
  {
    id: 'claude-3',
    name: 'Claude 3 Sonnet',
    icon: 'üé≠',
    description: 'ÊìÖÈïøÈïøÊñáÊú¨Â§ÑÁêÜÂíåÂàõÊÑèÂÜô‰Ωú',
    tags: ['ÂàõÊÑè', 'ÈïøÊñáÊú¨', 'ÁªÜËÖª'],
    config: {
      type: 'claude',
      apiUrl: 'api.anthropic.com/v1/messages',
      model: 'claude-3-sonnet-20240229',
      temperature: 0.7,
      maxTokens: null // ÁßªÈô§tokenÈôêÂà∂
    }
  },
  {
    id: 'wenxin',
    name: 'ÊñáÂøÉ‰∏ÄË®Ä',
    icon: 'üá®üá≥',
    description: '‰∏≠Êñá‰ºòÂåñÔºåÁêÜËß£‰∏≠ÊñáËØ≠Â¢ÉÊõ¥ÂáÜÁ°Æ',
    tags: ['‰∏≠Êñá', 'Êú¨Âúü', 'ËØ≠Â¢É'],
    config: {
      type: 'wenxin',
      apiUrl: 'aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions',
      model: 'ERNIE-Bot-4',
      temperature: 0.7,
      maxTokens: null // ÁßªÈô§tokenÈôêÂà∂
    }
  },
  {
    id: 'qwen',
    name: 'ÈÄö‰πâÂçÉÈóÆ',
    icon: 'üåü',
    description: 'ÈòøÈáå‰∫ëÈÄö‰πâÂçÉÈóÆÔºåÂ§öÊ®°ÊÄÅËÉΩÂäõÂº∫',
    tags: ['Â§öÊ®°ÊÄÅ', 'Êô∫ËÉΩ', 'ÂÖ®Èù¢'],
    config: {
      type: 'qwen',
      apiUrl: 'dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
      model: 'qwen-max',
      temperature: 0.7,
      maxTokens: null // ÁßªÈô§tokenÈôêÂà∂
    }
  },
  {
    id: 'zhipu',
    name: 'Êô∫Ë∞±AI',
    icon: 'üß†',
    description: 'Ê∏ÖÂçéÊô∫Ë∞±AIÔºå‰ª£Á†ÅÂíåÈÄªËæëËÉΩÂäõÁ™ÅÂá∫',
    tags: ['ÈÄªËæë', '‰ª£Á†Å', 'Êé®ÁêÜ'],
    config: {
      type: 'zhipu',
      apiUrl: 'open.bigmodel.cn/api/paas/v4/chat/completions',
      model: 'glm-4',
      temperature: 0.7,
      maxTokens: null // ÁßªÈô§tokenÈôêÂà∂
    }
  }
])

// ËÆ°ÁÆóÂ±ûÊÄß
const activeConfigs = computed(() => {
  return apiConfigs.value.filter(config => config.enabled && config.apiKey).length
})

const pendingConfigs = computed(() => {
  return apiConfigs.value.filter(config => !config.apiKey).length
})

const connectedConfigs = computed(() => {
  return apiConfigs.value.filter(config => config.status === 'connected').length
})

const defaultModel = computed(() => {
  const defaultConfig = apiConfigs.value.find(config => config.isDefault)
  return defaultConfig ? defaultConfig.name : 'Êú™ËÆæÁΩÆ'
})

// ÊñπÊ≥ï
const getStatusType = (status) => {
  const types = {
    connected: 'success',
    disconnected: 'danger',
    connecting: 'warning',
    error: 'danger'
  }
  return types[status] || 'info'
}

const getStatusIcon = (status) => {
  const icons = {
    connected: 'CircleCheck',
    disconnected: 'CircleClose',
    connecting: 'Loading',
    error: 'Warning'
  }
  return icons[status] || 'Question'
}

const getStatusText = (status) => {
  const texts = {
    connected: 'Â∑≤ËøûÊé•',
    disconnected: 'Êú™ËøûÊé•',
    connecting: 'ËøûÊé•‰∏≠',
    error: 'ËøûÊé•ÈîôËØØ'
  }
  return texts[status] || 'Êú™Áü•'
}

const addNewConfig = () => {
  const newId = String(Date.now())
  const newConfig = {
    id: newId,
    name: 'Êñ∞ÈÖçÁΩÆ',
    type: 'custom',
    description: '',
    apiUrl: '',
    apiKey: '',
    model: '',
    temperature: 0.7,
    maxTokens: 2000000, // ÈªòËÆ§ÊúÄÂ§ßTokenÊï∞
    unlimitedTokens: false, // ÈªòËÆ§‰∏çÊó†ÈôêÂà∂
    topP: 1.0,
    frequencyPenalty: 0.0,
    presencePenalty: 0.0,
    timeout: 30,
    isDefault: false,
    enabled: false,
    streamMode: true,
    retryCount: 3,
    priority: apiConfigs.value.length + 1,
    customHeaders: '',
    status: 'disconnected'
  }
  
  apiConfigs.value.push(newConfig)
  activeTab.value = newId
  ElMessage.success('Â∑≤Ê∑ªÂä†Êñ∞ÈÖçÁΩÆ')
}

const testConnection = async (config) => {
  if (!config.apiKey || !config.apiUrl) {
    ElMessage.warning('ËØ∑ÂÖàÂ°´ÂÜôAPIÂú∞ÂùÄÂíåÂØÜÈí•')
    return
  }
  
  config.status = 'connecting'
  ElMessage.info('Ê≠£Âú®ÊµãËØïËøûÊé•...')
  
  // Ê®°ÊãüËøûÊé•ÊµãËØï
  setTimeout(() => {
    const success = Math.random() > 0.3 // 70% ÊàêÂäüÁéá
    config.status = success ? 'connected' : 'error'
    
    if (success) {
      ElMessage.success(`${config.name} ËøûÊé•ÊµãËØïÊàêÂäü`)
    } else {
      ElMessage.error(`${config.name} ËøûÊé•ÊµãËØïÂ§±Ë¥•`)
    }
  }, 2000)
}

const testAllConnections = async () => {
  const enabledConfigs = apiConfigs.value.filter(config => config.enabled && config.apiKey)
  
  if (enabledConfigs.length === 0) {
    ElMessage.warning('Ê≤°ÊúâÂèØÊµãËØïÁöÑÈÖçÁΩÆ')
    return
  }
  
  ElMessage.info(`Ê≠£Âú®ÊµãËØï ${enabledConfigs.length} ‰∏™ÈÖçÁΩÆÁöÑËøûÊé•...`)
  
  for (const config of enabledConfigs) {
    await testConnection(config)
    await new Promise(resolve => setTimeout(resolve, 500)) // Èó¥Èöî500ms
  }
}

const saveConfig = (config) => {
  // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
  if (!config.name || !config.apiUrl) {
    ElMessage.warning('ËØ∑Â°´ÂÜôÈÖçÁΩÆÂêçÁß∞ÂíåAPIÂú∞ÂùÄ')
    return
  }
  
  // Â¶ÇÊûúËÆæ‰∏∫ÈªòËÆ§ÔºåÂèñÊ∂àÂÖ∂‰ªñÈªòËÆ§ÈÖçÁΩÆ
  if (config.isDefault) {
    apiConfigs.value.forEach(c => {
      if (c.id !== config.id) {
        c.isDefault = false
      }
    })
  }
  
  ElMessage.success(`${config.name} ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò`)
}

const saveAllConfigs = () => {
  const validConfigs = apiConfigs.value.filter(config => config.name && config.apiUrl)
  
  if (validConfigs.length === 0) {
    ElMessage.warning('Ê≤°ÊúâÊúâÊïàÁöÑÈÖçÁΩÆÂèØ‰øùÂ≠ò')
    return
  }
  
  // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
  localStorage.setItem('aiApiConfigs', JSON.stringify(apiConfigs.value))
  ElMessage.success(`Â∑≤‰øùÂ≠ò ${validConfigs.length} ‰∏™ÈÖçÁΩÆ`)
}

const resetConfig = (config) => {
  ElMessageBox.confirm(
    'Á°ÆÂÆöË¶ÅÈáçÁΩÆÊ≠§ÈÖçÁΩÆÂêóÔºüÊâÄÊúâËÆæÁΩÆÂ∞ÜÊÅ¢Â§ç‰∏∫ÈªòËÆ§ÂÄº„ÄÇ',
    'ÈáçÁΩÆÈÖçÁΩÆ',
    {
      confirmButtonText: 'Á°ÆÂÆö',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning'
    }
  ).then(() => {
    // ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº
    Object.assign(config, {
      temperature: 0.7,
      maxTokens: null, // ÁßªÈô§tokenÈôêÂà∂
      topP: 1.0,
      frequencyPenalty: 0.0,
      presencePenalty: 0.0,
      timeout: 30,
      streamMode: true,
      retryCount: 3,
      customHeaders: '',
      status: 'disconnected'
    })
    
    ElMessage.success('ÈÖçÁΩÆÂ∑≤ÈáçÁΩÆ')
  })
}

// Â§ÑÁêÜÊó†ÈôêÂà∂TokenÈÄâÈ°π
const handleUnlimitedTokensChange = (config) => {
  if (config.unlimitedTokens) {
    config.maxTokens = null
  } else {
    config.maxTokens = 2000000 // ÊÅ¢Â§çÂà∞Áî®Êà∑ËÆæÂÆöÁöÑÈªòËÆ§ÂÄº
  }
}

const duplicateConfig = (config) => {
  const newId = String(Date.now())
  const duplicatedConfig = {
    ...config,
    id: newId,
    name: `${config.name} (ÂâØÊú¨)`,
    isDefault: false,
    status: 'disconnected'
  }
  
  apiConfigs.value.push(duplicatedConfig)
  activeTab.value = newId
  ElMessage.success('ÈÖçÁΩÆÂ∑≤Â§çÂà∂')
}

const deleteConfig = (configId) => {
  const config = apiConfigs.value.find(c => c.id === configId)
  
  if (config.isDefault) {
    ElMessage.warning('‰∏çËÉΩÂà†Èô§ÈªòËÆ§ÈÖçÁΩÆ')
    return
  }
  
  ElMessageBox.confirm(
    `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÖçÁΩÆ "${config.name}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`,
    'Âà†Èô§ÈÖçÁΩÆ',
    {
      confirmButtonText: 'Á°ÆÂÆö',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning'
    }
  ).then(() => {
    const index = apiConfigs.value.findIndex(c => c.id === configId)
    apiConfigs.value.splice(index, 1)
    
    // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÊøÄÊ¥ªÁöÑÊ†áÁ≠æÔºåÂàáÊç¢Âà∞Á¨¨‰∏Ä‰∏™
    if (activeTab.value === configId && apiConfigs.value.length > 0) {
      activeTab.value = apiConfigs.value[0].id
    }
    
    ElMessage.success('ÈÖçÁΩÆÂ∑≤Âà†Èô§')
  })
}

const applyTemplate = (template) => {
  ElMessageBox.confirm(
    `Á°ÆÂÆöË¶ÅÂ∫îÁî®Ê®°Êùø "${template.name}" ÂêóÔºüËøôÂ∞ÜÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÈÖçÁΩÆ„ÄÇ`,
    'Â∫îÁî®Ê®°Êùø',
    {
      confirmButtonText: 'Á°ÆÂÆö',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'info'
    }
  ).then(() => {
    const newId = String(Date.now())
    const newConfig = {
      id: newId,
      name: template.name,
      description: template.description,
      ...template.config,
      unlimitedTokens: template.config.maxTokens === null, // Ê†πÊçÆmaxTokensËÆæÁΩÆunlimitedTokens
      topP: 1.0,
      frequencyPenalty: 0.0,
      presencePenalty: 0.0,
      timeout: 30,
      isDefault: false,
      enabled: false,
      streamMode: true,
      retryCount: 3,
      priority: apiConfigs.value.length + 1,
      customHeaders: '',
      status: 'disconnected',
      apiKey: ''
    }
    
    apiConfigs.value.push(newConfig)
    activeTab.value = newId
    ElMessage.success(`Â∑≤Â∫îÁî®Ê®°Êùø "${template.name}"`)
  })
}

const exportConfigs = () => {
  const configsToExport = apiConfigs.value.map(config => ({
    ...config,
    apiKey: '' // ‰∏çÂØºÂá∫ÊïèÊÑü‰ø°ÊÅØ
  }))
  
  const dataStr = JSON.stringify(configsToExport, null, 2)
  const dataBlob = new Blob([dataStr], { type: 'application/json' })
  
  const link = document.createElement('a')
  link.href = URL.createObjectURL(dataBlob)
  link.download = `ai-api-configs-${new Date().toISOString().split('T')[0]}.json`
  link.click()
  
  ElMessage.success('ÈÖçÁΩÆÂ∑≤ÂØºÂá∫')
}

const importConfigs = (file) => {
  const reader = new FileReader()
  
  reader.onload = (e) => {
    try {
      const importedConfigs = JSON.parse(e.target.result)
      
      if (!Array.isArray(importedConfigs)) {
        throw new Error('Êó†ÊïàÁöÑÈÖçÁΩÆÊñá‰ª∂Ê†ºÂºè')
      }
      
      ElMessageBox.confirm(
        `Á°ÆÂÆöË¶ÅÂØºÂÖ• ${importedConfigs.length} ‰∏™ÈÖçÁΩÆÂêóÔºüËøôÂ∞ÜË¶ÜÁõñÁé∞ÊúâÈÖçÁΩÆ„ÄÇ`,
        'ÂØºÂÖ•ÈÖçÁΩÆ',
        {
          confirmButtonText: 'Á°ÆÂÆö',
          cancelButtonText: 'ÂèñÊ∂à',
          type: 'warning'
        }
      ).then(() => {
        apiConfigs.value = importedConfigs.map((config, index) => ({
          ...config,
          id: String(Date.now() + index),
          status: 'disconnected'
        }))
        
        if (apiConfigs.value.length > 0) {
          activeTab.value = apiConfigs.value[0].id
        }
        
        ElMessage.success(`Â∑≤ÂØºÂÖ• ${importedConfigs.length} ‰∏™ÈÖçÁΩÆ`)
      })
    } catch (error) {
      ElMessage.error('ÈÖçÁΩÆÊñá‰ª∂Ê†ºÂºèÈîôËØØ')
    }
  }
  
  reader.readAsText(file)
  return false // ÈòªÊ≠¢ÈªòËÆ§‰∏ä‰º†Ë°å‰∏∫
}

const resetAllConfigs = () => {
  ElMessageBox.confirm(
    'Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÈÖçÁΩÆÂêóÔºüËøôÂ∞ÜÂà†Èô§ÊâÄÊúâËá™ÂÆö‰πâÈÖçÁΩÆÂπ∂ÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆ„ÄÇ',
    'ÈáçÁΩÆÊâÄÊúâÈÖçÁΩÆ',
    {
      confirmButtonText: 'Á°ÆÂÆö',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning'
    }
  ).then(() => {
    // ÈáçÁΩÆ‰∏∫ÂàùÂßãÈÖçÁΩÆ
    apiConfigs.value = [
      {
        id: '1',
        name: 'OpenAI GPT-4',
        type: 'openai',
        description: 'OpenAI GPT-4 Ê®°ÂûãÈÖçÁΩÆ',
        apiUrl: 'api.openai.com/v1/chat/completions',
        apiKey: '',
        model: 'gpt-4',
        temperature: 0.7,
        maxTokens: null, // ÁßªÈô§tokenÈôêÂà∂
        unlimitedTokens: true, // ÈªòËÆ§Êó†ÈôêÂà∂
        topP: 1.0,
        frequencyPenalty: 0.0,
        presencePenalty: 0.0,
        timeout: 30,
        isDefault: true,
        enabled: true,
        streamMode: true,
        retryCount: 3,
        priority: 1,
        customHeaders: '',
        status: 'disconnected'
      }
    ]
    
    activeTab.value = '1'
    ElMessage.success('ÊâÄÊúâÈÖçÁΩÆÂ∑≤ÈáçÁΩÆ')
  })
}

const showHistory = ref(false)

// ÁîüÂëΩÂë®Êúü
onMounted(() => {
  // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÈÖçÁΩÆ
  const savedConfigs = localStorage.getItem('aiApiConfigs')
  if (savedConfigs) {
    try {
      const configs = JSON.parse(savedConfigs)
      // ‰∏∫Áé∞ÊúâÈÖçÁΩÆÊ∑ªÂä†unlimitedTokensÂ≠óÊÆµ
      apiConfigs.value = configs.map(config => ({
        ...config,
        unlimitedTokens: config.unlimitedTokens !== undefined ? config.unlimitedTokens : (config.maxTokens === null)
      }))
      if (apiConfigs.value.length > 0) {
        activeTab.value = apiConfigs.value[0].id
      }
    } catch (error) {
      console.error('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•:', error)
    }
  }
})
</script>

<style scoped>
.api-config {
  padding: 0;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header-content h1 {
  margin: 0 0 5px 0;
  font-size: 24px;
  color: #303133;
}

.header-content p {
  margin: 0;
  color: #606266;
  font-size: 14px;
}

.header-actions {
  display: flex;
  gap: 10px;
}

.config-overview {
  margin-bottom: 20px;
}

.status-card {
  height: 100%;
}

.status-item {
  display: flex;
  align-items: center;
  gap: 15px;
}

.status-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  color: white;
}

.status-icon.success {
  background: linear-gradient(135deg, #67c23a, #85ce61);
}

.status-icon.warning {
  background: linear-gradient(135deg, #e6a23c, #f0a020);
}

.status-icon.info {
  background: linear-gradient(135deg, #409eff, #66b1ff);
}

.status-icon.primary {
  background: linear-gradient(135deg, #909399, #b3b6bb);
}

.status-content {
  flex: 1;
}

.status-value {
  font-size: 24px;
  font-weight: 600;
  color: #303133;
  margin-bottom: 5px;
}

.status-label {
  font-size: 14px;
  color: #606266;
}

.config-list {
  margin-bottom: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-header h3 {
  margin: 0;
  color: #303133;
}

.config-tabs {
  margin-top: 20px;
}

.config-content {
  padding: 20px 0;
}

.config-section {
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 1px solid #ebeef5;
}

.config-section:last-child {
  border-bottom: none;
}

.config-section h4 {
  margin: 0 0 20px 0;
  color: #303133;
  font-size: 16px;
  font-weight: 600;
}

.config-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  padding-top: 20px;
  border-top: 1px solid #ebeef5;
}

.max-tokens-control {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.preset-templates {
  margin-bottom: 20px;
}

.template-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.template-card {
  padding: 20px;
  border: 1px solid #ebeef5;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  gap: 15px;
}

.template-card:hover {
  border-color: #409eff;
  box-shadow: 0 4px 8px rgba(64, 158, 255, 0.2);
}

.template-icon {
  font-size: 32px;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f5f7fa;
  border-radius: 8px;
}

.template-content {
  flex: 1;
}

.template-content h4 {
  margin: 0 0 8px 0;
  color: #303133;
  font-size: 16px;
}

.template-content p {
  margin: 0 0 10px 0;
  color: #606266;
  font-size: 14px;
  line-height: 1.4;
}

.template-tags {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
}

.import-export {
  margin-bottom: 20px;
}

.import-export-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 30px;
}

.action-group h4 {
  margin: 0 0 8px 0;
  color: #303133;
  font-size: 16px;
}

.action-group p {
  margin: 0 0 15px 0;
  color: #606266;
  font-size: 14px;
  line-height: 1.4;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .page-header {
    flex-direction: column;
    gap: 15px;
    text-align: center;
  }
  
  .config-actions {
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .template-grid {
    grid-template-columns: 1fr;
  }
  
  .import-export-actions {
    grid-template-columns: 1fr;
  }
}
</style>